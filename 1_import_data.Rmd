---
title: "Import sequencing data into R"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = "center")
library("knitr")
```

There are many ways to import data into R, and numerous packages are available to analyze metabarcoding data. Among these, [Phyloseq](http://www.r-project.org) remains a versatile tool to import, store and analyze data. Moreover, many other packages can use a Phyloseq object as a starting point. We'll start by importing the tables using the Phyloseq package. 

For these steps wee will need the following libraries: 

```{r, message=FALSE,echo=TRUE}
library("tidyverse")
library("phyloseq")
```

Tables to Phyloseq
----
Let's start by importing the saved tables into the raw_data directory, using the basic read.csv function, and checking the first rows and columns with the head() function.

```{r}
biom_illumina<- read.csv("Raw_data/Illumina/illumina_ASV_table.tsv", 
                        header=TRUE, sep="\t")
head(biom_illumina[,1:5],10)
```

Then import the taxonomy table in the same way.

```{r}
taxo_illumina<- read.csv("Raw_data/Illumina/illumina_taxonomy.tsv", 
                        header=TRUE, sep="\t")
head(taxo_illumina[,1:8],10)
```

Then define the row names from the otu column

```{r}
biom_illumina <- biom_illumina %>%
  tibble::column_to_rownames("otu") 

taxo_illumina <- taxo_illumina %>%
  tibble::column_to_rownames("otu") 
```

Transform otu and taxonomy tables into matrixes

```{r}
biom_illumina <- as.matrix(biom_illumina)
taxo_illumina <- as.matrix(taxo_illumina)

class(biom_illumina)
class(taxo_illumina) 
```

convert to phyloseq objects

```{r}
OTU_illumina = otu_table(biom_illumina, taxa_are_rows = TRUE)
TAX_illumina = phyloseq::tax_table(taxo_illumina)

illuminaPS <- phyloseq(OTU_illumina, TAX_illumina)
illuminaPS
```


Let's repeat for the IonTorrent dataset 

```{r}
biom_IonTorrent<- read.csv("Raw_data/IonTorrent/iontorrent_ASV_table.tsv", 
                        header=TRUE, sep="\t")
head(biom_IonTorrent[,1:5],10)


taxo_IonTorrent<- read.csv("Raw_data/IonTorrent/iontorrent_taxonomy.tsv", 
                        header=TRUE, sep="\t")
head(taxo_IonTorrent[,1:8],10)

biom_IonTorrent <- biom_IonTorrent %>%
  tibble::column_to_rownames("otu") 

taxo_IonTorrent <- taxo_IonTorrent %>%
  tibble::column_to_rownames("otu") 

biom_IonTorrent <- as.matrix(biom_IonTorrent)
taxo_IonTorrent <- as.matrix(taxo_IonTorrent)

class(biom_IonTorrent)
class(taxo_IonTorrent) 

OTU_IonTorrent = otu_table(biom_IonTorrent, taxa_are_rows = TRUE)
TAX_IonTorrent = phyloseq::tax_table(taxo_IonTorrent)

IonTorrentPS <- phyloseq(OTU_IonTorrent, TAX_IonTorrent)
IonTorrentPS
```

And Again for the Nanopore dataset 

```{r}
biom_Nanopore<- read.csv("Raw_data/Nanopore/Nanopore_pseudo_ASV_table.csv", 
                        header=TRUE, sep=";")
head(biom_Nanopore[,1:5],10)


taxo_Nanopore<- read.csv("Raw_data/Nanopore/Nanopore_taxonomy.csv", 
                        header=TRUE, sep=";")
head(taxo_Nanopore[,1:8],10)

biom_Nanopore <- biom_Nanopore %>%
  tibble::column_to_rownames("otu") 

taxo_Nanopore <- taxo_Nanopore %>%
  tibble::column_to_rownames("otu") 


biom_Nanopore <- as.matrix(biom_Nanopore)
taxo_Nanopore <- as.matrix(taxo_Nanopore)

class(biom_Nanopore)
class(taxo_Nanopore) 

OTU_Nanopore = otu_table(biom_Nanopore, taxa_are_rows = TRUE)
TAX_Nanopore = phyloseq::tax_table(taxo_Nanopore)

NanoporePS <- phyloseq(OTU_Nanopore, TAX_Nanopore)
NanoporePS
```

Merging phyloseq objects
----

To compare 


```{r}
otu_illumina = otu_table(illuminaPS)
otu_Iontorrent = otu_table(IonTorrentPS)
otu_Nanopore = otu_table(NanoporePS)

combined_otu <- merge_phyloseq(otu_illumina, otu_Iontorrent, otu_Nanopore)
```


```{r}
tax_illumina  = phyloseq::tax_table(illuminaPS)
tax_Iontorrent = phyloseq::tax_table(IonTorrentPS)
tax_Nanopore = phyloseq::tax_table(NanoporePS)

combined_tax <- merge_phyloseq(tax_illumina, tax_Iontorrent, tax_Nanopore)

head(combined_tax)

combined_tax <- as.matrix(combined_tax)
combined_tax = phyloseq::tax_table(combined_tax)
```


We now have 3 Phyloseq objects, which contain no metadata.



```{r}
meta <- read.csv("Raw_data/metadata_organicsoil1.tsv", 
                 header=TRUE, sep="\t")
head(meta)

meta <- meta %>% 
  tibble::column_to_rownames("SampleID")

samples = sample_data(meta)
```

merge the otu, tax and meta objects into a final PS object: 

```{r}
combinedPS <- merge_phyloseq(combined_otu, combined_tax, samples);combinedPS

```

Saving phyloseq objects
----












